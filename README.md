My Rocks and slurm notes
========================

## Add/delete Users


### Add New Users

```
su -
useradd username
passwd username
rocks sync users
```

Set the full name of the user using the command

```
chfn  -f "FirstName  Surname"  username
```

### Deleting Users

```
userdel username
delete user home directory manually
```

Missing /etc/411-security/shared.key issue
When a node reinstalls, it is supposed to ask the frontend to sync the sharedkey. It usually works,
but apparently not always (e.g. a rocks bug). Without the shared key, the nodes can't decode the 411 files (by design). the 411 files do contain crypted passwords.

to fix it, use

`rocks sync host sharedkey compute`

Comments on "/etc/default/useradd"
The default home directory for "useradd" command is set to be "/export/home". The "rock sync users" command only recognizes this directory and automatically change "/export/home/username" in /etc/passwd to "/home/username". In addition, it updates auto.home and passwd file to compute nodes, but only if we use the default home directory "/export/home".

## Change timezone on Rocks Cluster

On Rocks Cluster when install new compute node, timezone will same as frontend. If we want to change existing rocks, we use command “timedatectl” to change.

But when new compute installing, it still set default time zone, we must change attribute Kickstart_Timezone in frontend.

Example : change time zone to America/Newyork to Asia/Tehran

### change timezone for frontend and compute

`timedatectl set-timezone Asia/Tehran`
`tentakel timedatectl set-timezone Asia/Tehran`

### change attribute Kickstart_Timezone for new compute installed

`rocks set attr Kickstart_Timezone Asia/Tehran`

### SLURM notes

### Rename and modify the CLUSTER (auto-generated by the slurm roll) partition

Modify the /etc/slurm/CLUSTER.options.default to

```
PartitionName=PARA DEFAULT=NO STATE=UP MaxTime=1-00:00:00 DefaultTime=00:30:00
```
and then do `rocks sync slurm`.


### Add a slurm partition

Edit `/etc/slurm/parts ` for example:

```
PartitionName=WHEEL RootOnly=yes Priority=1000 Nodes=ALL
PartitionName=SHORT MaxTime=1-0:0 DefaultTime=00:30:00 MaxNodes=1
PartitionName=LONG MaxTime=7-0:0 DefaultTime=00:30:00 MaxNodes=1
```

Then assign a node to the created partition

```
rocks add host attr compute-0-0 slurm_partitions value='|WHEEL|SHORT|LONG|'
rocks add host attr compute-0-1 slurm_partitions value='|PARA|WHEEL|LONG|'
rocks add host attr compute-0-2 slurm_partitions value='|PARA|WHEEL|LONG|'
rocks add host attr compute-0-3 slurm_partitions value='|PARA|WHEEL|LONG|'
```

If the attribute already exists, do

```
rocks set host attr compute-0-0 slurm_partitions value='|WHEEL|SHORT|LONG|'
rocks set host attr compute-0-1 slurm_partitions value='|PARA|WHEEL|LONG|'
rocks set host attr compute-0-2 slurm_partitions value='|PARA|WHEEL|LONG|'
rocks set host attr compute-0-3 slurm_partitions value='|PARA|WHEEL|LONG|'
```

And finally don't forget to do `rocks sync slurm`.

### Install developer toolset 7

All steps must be run in frontend.

Enable saving downloaded RPMs in`vim /etc/yum.conf` by changing `keepcache=0` to `keepcache=1`. Then

```
yum --enablerepo=extras install centos-release-scl
```
To just download the package you can do

```
yumdownloader --enablerepo=extras centos-release-scl
```
Then install devtoolset-7
```
yum --enablerepo=centos-sclo-rh install devtoolset-7
```
To test it: `scl enable devtoolset-7 bash`

Then move downloaded packages for next use (node re-installation)

```
mkdir ~/devtoolset-7
mv /var/cache/yum/x86_64/7/extras/packages/*.rpm ~/devtoolset-7
mv /var/cache/yum/x86_64/7/centos-sclo-rh/packages/*.rpm ~/devtoolset-7
```
Make a packages list file

```
cd ~/devtoolset-7 && ls *.rpm > ~/rpm_names && cd ~ && python ./package.py < rpm_names > rpm_names_with_packages
```

Now, copy RPMs to `/export/rocks/install/contrib/7.0/x86_64/RPMS`

```
cp ~/devtoolset-7/*.rpm /export/rocks/install/contrib/7.0/x86_64/RPMS/
```

Create a new XML configuration file that will extend the current compute.xml configuration file:

```
cd /export/rocks/install/site-profiles/7.0/nodes
cp skeleton.xml extend-compute.xml
```

Copy the content of `rpm_names_with_packages` in `extend-compute.xml`. See ([here](http://www.rocksclusters.org/assets/usersguides/roll-documentation/base/6.1/customization-adding-packages.html)). Then

```
cd /export/rocks/install
rocks create distro
```
And re-install the nodes:

```
rocks set host boot compute-0-0 action=install
rocks run host compute "shutdown -r now"
```
